<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Healthguard Admin</title>
<link rel="icon" href="images/icon2.png" type="image/jpeg">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
body { overflow-x: hidden; }
.sidebar {
  width: 250px;
  height: 100vh;
  position: fixed;
  top: 0;
  left: 0;
  background-color: #212529;
  color: #fff;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: width 0.3s, padding 0.3s;
  padding: 1rem 1rem;
  z-index: 1050;
}
.sidebar.collapsed {
  width: 70px;
  padding-left: 0.5rem;
  padding-right: 0.5rem;
}
.sidebar .nav-link {
  color: #fafdff;
  white-space: nowrap;
  display: flex;
  align-items: center;
  position: relative;
  transition: justify-content 0.3s;
}
.sidebar .nav-link.active { background-color: #0d6efd; color: #fff; }
.sidebar .nav-link:hover { color: #fff; }
.sidebar-text { margin-left: 0.5rem; transition: opacity 0.3s; }
.sidebar.collapsed .sidebar-text { display: none; }
.sidebar.collapsed .nav-link { justify-content: center; }
.sidebar.collapsed .nav-link:hover::after {
  content: attr(data-text);
  position: absolute;
  left: 70px;
  top: 50%;
  transform: translateY(-50%);
  background: #212529;
  padding: 3px 10px;
  border-radius: 4px;
  white-space: nowrap;
  z-index: 1100;
}
.toggle-btn {
  display: inline-block;
  background-color: #212529;
  color: #fff;
  border: none;
}
.sidebar.collapsed .toggle-btn { display: none; }
.main-content { margin-left: 250px; padding: 2rem; transition: margin-left 0.3s; }
.sidebar.collapsed ~ .main-content { margin-left: 70px; }
.sidebar hr { transition: opacity 0.3s; }
.sidebar.collapsed hr { display: none; }
.sidebar .dropdown-toggle::after { transition: opacity 0.3s; }
.sidebar.collapsed .dropdown-toggle::after { opacity: 0; pointer-events: none; }

#dataDistrict,
#dataDisease,
#dataState {
  -webkit-appearance: none; /* Safari/Chrome */
  -moz-appearance: none;    /* Firefox */
  appearance: none;         /* Standard */
  background-image: none !important; /* Remove any default arrow */
}
/* ================= MOBILE ADMIN FIX ================= */
@media (max-width: 991px) {

  .mobile-header {
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    height: 55px;
    background: #212529;
    color: #fff;
    display: flex;
    align-items: center;
    padding: 0 15px;
    z-index: 1100;
  }

  .sidebar {
    left: -250px;
    transition: left 0.3s ease;
  }

  .sidebar.mobile-open {
    left: 0;
  }

  .sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 1040;
  }

  .sidebar-overlay.active {
    display: block;
  }

  .main-content {
    margin-left: 0 !important;
    padding-top: 70px;
  }

}
/* ---------- DATA ENTRY MOBILE FIX ---------- */
@media (max-width: 991px) {

  /* Make form fields full width */
  #dataentry-section .row > div {
    flex: 0 0 100%;
    max-width: 100%;
  }

  #dataentry-section label {
    font-size: 14px;
  }

  #dataentry-section .form-control,
  #dataentry-section .form-select {
    font-size: 14px;
  }

  #dataentry-section button {
    width: 100%;
  }

}
.analytics-frame {
  width: 100%;
  border: none;
  height: 650px;
  border-radius: 12px;
}

@media (max-width: 991px) {
  .analytics-frame {
    height: 520px;
  }
}

@media (max-width: 576px) {
  .analytics-frame {
    height: 450px;
  }
}
@media (max-width: 991px) {
  .main-content {
    padding: 1rem;
  }

  h1.h2 {
    font-size: 22px;
    margin-bottom: 1rem;
  }
}


</style>
</head>
<body>
<!-- Mobile Header -->
<div class="mobile-header d-lg-none">
  <button id="mobileMenuBtn" class="btn btn-dark">
    <i class="bi bi-list"></i>
  </button>
  <span class="fw-bold ms-2">Healthguard Admin</span>
</div>

<div class="sidebar" id="sidebar">
  <div class="flex-grow-1 d-flex flex-column">
    <div class="d-flex align-items-center mb-3 justify-content-between">
      <div class="d-flex align-items-center" onclick="window.location.href='index.html'">
        <img src="images/icon1.png" width="40" height="40" style="margin-left: 10px;" alt="HealthGuard" class="me-2">
        <span class="fs-5 fw-bold sidebar-text" style="font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif">Healthguard</span>
      </div>
      <button id="sidebarToggle" class="btn btn-sm toggle-btn" ><i  class="bi bi-list"></i></button>
    </div>
    <hr class="text-secondary">
    <ul class="nav flex-column">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-text="Dashboard"><i class="bi bi-speedometer2"></i><span class="sidebar-text">Dashboard</span></a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-text="Subscribers"><i class="bi bi-people"></i><span class="sidebar-text">Subscribers</span></a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-text="Users"><i class="bi bi-person-badge"></i><span class="sidebar-text">Users</span></a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-text="Data Entry"><i class="bi bi-journal-text"></i><span class="sidebar-text">Data Entry</span></a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-text="Notifications"><i class="bi bi-bell"></i><span class="sidebar-text">Notifications</span></a>
      </li>
    </ul>
    
  </div>

  <hr class="text-secondary m-0">
  <div class="dropdown px-3 mt-2">
    <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="adminDropdown" data-bs-toggle="dropdown">
      <i class="bi bi-person-circle fs-4 me-2"></i><strong class="sidebar-text">ADMIN</strong>
    </a>
    <ul class="dropdown-menu dropdown-menu-dark shadow">
<li><a class="dropdown-item" href="#" id="settingsBtn">Settings</a></li>
<li><a class="dropdown-item" href="#" id="logoutBtn">Sign out</a></li>

    </ul>
  </div>
</div>
<div class="sidebar-overlay d-lg-none" id="sidebarOverlay"></div>

<script>
// Admin dropdown actions
document.addEventListener('DOMContentLoaded', () => {
  const adminDropdown = document.getElementById('adminDropdown');

  // Settings click
  document.getElementById('settingsBtn').addEventListener('click', (e) => {
  e.preventDefault();
  window.location.href = 'adminsettings.html';
});

document.getElementById('logoutBtn').addEventListener('click', (e) => {
  e.preventDefault();
  window.location.href = 'login.html';
});

});
</script>

<div class="main-content">

<!-- Dashboard -->
<div id="dashboard-section">
  <h1 class="h2">Dashboard</h1>
  <p>Welcome to the Healthguard admin panel.</p>
  <div class="row g-3 mt-3">
    <div class="col-md-6">
      <div class="card text-center clickable-card" data-target="Subscribers">
        <div class="card-body">
          <div class="fs-2 mb-2">üë•</div>
          <h5 class="card-title">Total Subscribers</h5>
          <p class="card-text" id="subscribers-count">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center clickable-card" data-target="Users">
        <div class="card-body">
          <div class="fs-2 mb-2">üßë‚Äçüíª</div>
          <h5 class="card-title">Total Users</h5>
          <p class="card-text" id="users-count">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center clickable-card" data-target="Data Entry">
        <div class="card-body">
          <div class="fs-2 mb-2">üìÑ</div>
          <h5 class="card-title">Total Data Entries</h5>
          <p class="card-text" id="entries-count">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card text-center clickable-card" data-target="Notifications">
        <div class="card-body">
          <div class="fs-2 mb-2">üîî</div>
          <h5 class="card-title">Notifications Sent</h5>
          <p class="card-text" id="notifications-count">0</p>
        </div>
      </div>
    </div>
  </div>
</div>



<style>
.clickable-card { cursor: pointer; transition: transform 0.2s; }
.clickable-card:hover { transform: scale(1.03); }
</style>

<script>
// Make dashboard cards clickable
document.querySelectorAll('.clickable-card').forEach(card => {
  card.addEventListener('click', function() {
    const target = this.getAttribute('data-target');
    
    // Hide all sections
    Object.values(sections).forEach(id => {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
});

    
    // Show the target section
    if (sections[target]) {
      document.getElementById(sections[target]).style.display = 'block';
      
      // Trigger sidebar highlight
      document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`.sidebar .nav-link[data-text="${target}"]`).classList.add('active');
      
      // Call corresponding load function
      if(target === "Subscribers") loadSubscribers();
      if(target === "Users") loadUsers();
      if(target === "Data Entry") loadEntries();
      if(target === "Notifications") loadNotifications();
    }
  });
});
const mobileMenuBtn = document.getElementById("mobileMenuBtn");
const sidebarOverlay = document.getElementById("sidebarOverlay");

// Open sidebar
mobileMenuBtn?.addEventListener("click", () => {
  sidebar.classList.add("mobile-open");
  sidebarOverlay.classList.add("active");
});

// Close sidebar when overlay clicked
sidebarOverlay?.addEventListener("click", () => {
  sidebar.classList.remove("mobile-open");
  sidebarOverlay.classList.remove("active");
});

</script>


  <!-- Subscribers -->
  <div id="subscribers-section" style="display:none;">
    <h1 class="h2">Subscribers</h1>
    <p>List of all subscribers.</p>
    <div class="table-responsive">
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>State</th>
          <th>District</th>
          <th>Disease</th>
          <th>Approved</th>
        </tr>
      </thead>
      <tbody id="subscribers-table">
        <tr><td colspan="7">Loading...</td></tr>
      </tbody>
    </table></div>
  </div>

  <!-- Users -->
  <div id="users-section" style="display:none;">
    <h1 class="h2">Users</h1>
    <p>Manage system users here.</p>
    <div class="table-responsive">
    <table class="table table-striped mt-3">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Gender</th>
          <th>Date of Birth</th>
          <th>State</th>
        </tr>
      </thead>
      <tbody id="users-table">
        <tr><td colspan="6">Loading...</td></tr>
      </tbody>
    </table></div>
  </div>

<!-- Data Entry -->
<div id="dataentry-section" style="display:none;">
  <h1 class="h2">Data Entry</h1>
  <p>Enter or edit Disease records here.</p>
  <form class="mt-3 mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label >Disease</label>
          <select class="form-select" id="dataDisease">
           <option value="" disabled selected>Select Disease</option>
           <option>COVID-19</option>
           <option>Dengue</option>
           <option>Chikungunya</option>
           <option>Zika</option>
           <option>HFMD</option>
           <option>Hepatitis A/E</option>
           <option>Other</option>
         </select>
        </div>
        <div class="col-md-3">
          <label for="dataState">State</label>
          <select class="form-control" id="dataState">
            <option value="" disabled selected>-- Select State --</option>
            <option value="Andhra Pradesh">Andhra Pradesh</option>
            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
            <option value="Assam">Assam</option>
            <option value="Bihar">Bihar</option>
            <option value="Chhattisgarh">Chhattisgarh</option>
            <option value="Goa">Goa</option>
            <option value="Gujarat">Gujarat</option>
            <option value="Haryana">Haryana</option>
            <option value="Himachal Pradesh">Himachal Pradesh</option>
            <option value="Jharkhand">Jharkhand</option>
            <option value="Karnataka">Karnataka</option>
            <option value="Kerala">Kerala</option>
            <option value="Madhya Pradesh">Madhya Pradesh</option>
            <option value="Maharashtra">Maharashtra</option>
            <option value="Manipur">Manipur</option>
            <option value="Meghalaya">Meghalaya</option>
            <option value="Mizoram">Mizoram</option>
            <option value="Nagaland">Nagaland</option>
            <option value="Odisha">Odisha</option>
            <option value="Punjab">Punjab</option>
            <option value="Rajasthan">Rajasthan</option>
            <option value="Sikkim">Sikkim</option>
            <option value="Tamil Nadu">Tamil Nadu</option>
            <option value="Telangana">Telangana</option>
            <option value="Tripura">Tripura</option>
            <option value="Uttar Pradesh">Uttar Pradesh</option>
            <option value="Uttarakhand">Uttarakhand</option>
            <option value="West Bengal">West Bengal</option>
            <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option>
            <option value="Chandigarh">Chandigarh</option>
            <option value="Dadra and Nagar Haveli and Daman and Diu">Dadra and Nagar Haveli and Daman and Diu</option>
            <option value="Delhi">Delhi</option>
            <option value="Jammu and Kashmir">Jammu and Kashmir</option>
            <option value="Ladakh">Ladakh</option>
            <option value="Lakshadweep">Lakshadweep</option>
            <option value="Puducherry">Puducherry</option>
          </select>
        </div>

        <div class="col-md-2">
          <label>District</label>
          <select class="form-select" id="dataDistrict">
            <option value="">Select District</option>
          </select>
        </div>

        <div class="col-md-2">
          <label>Date</label>
          <input type="date" class="form-control">
        </div>
        <div class="col-md-2">
  <label>Count</label>
  <input type="number" class="form-control" value="0" min="0" placeholder="Enter count">
</div>

      </div>
      <button type="submit" class="btn btn-primary mt-3">Add Entry</button>
    </form>
    <div class="table-responsive">
 <table class="table table-striped mt-3">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>State</th>
      <th>District</th>
      <th>Disease</th>
      <th>Count</th>
      <th>Added At</th>
      <th>Status</th>
      <th>Actions</th> <!-- New column for Delete button -->
    </tr>
  </thead>
  <tbody id="entries-table">
    <tr><td colspan="8">Loading...</td></tr> <!-- update colspan to 8 -->
  </tbody>
</table></div>

</div>



<!-- Notifications -->
<div id="notifications-section" style="display:none;">
  <h1 class="h2">Notifications</h1>
  <p>All sent email notifications to subscribers and users.</p>
  <div class="table-responsive">
  <table class="table table-striped mt-3">
    <thead>
      <tr>
        <th>Recipient Name</th>
        <th>Recipient Type</th>
        <th>Email</th>
        <th>Message</th>
        <th>Sent At</th>
      </tr>
    </thead>
    <tbody id="notifications-table">
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table></div>
</div>

</div>

<script>

// -------------------- Utility --------------------
function formatDate(dateStr) {
  const d = new Date(dateStr);
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

// -------------------- Section Toggle --------------------
const sections = {
  'Dashboard': 'dashboard-section',
  'Subscribers': 'subscribers-section',
  'Users': 'users-section',
  'Data Entry': 'dataentry-section',
  'Notifications': 'notifications-section' // Added Notifications section
};

const sidebar = document.getElementById('sidebar');
const mainContent = document.querySelector('.main-content');
const sidebarToggleBtn = document.getElementById('sidebarToggle');

// Function to show a section and hide others
function showSection(name) {
  Object.values(sections).forEach(id => document.getElementById(id).style.display = 'none');
  if (sections[name]) {
  const el = document.getElementById(sections[name]);
  if (el) el.style.display = 'block';
}


  // Load data if needed
  if(name === "Dashboard") loadDashboardStats();
  if(name === "Subscribers") loadSubscribers();
  if(name === "Users") loadUsers();
  if(name === "Data Entry") loadEntries();
  if(name === "Notifications") loadNotifications(); // load notifications
}

// Function to expand sidebar
function expandSidebar() {
  sidebar.classList.remove('collapsed');
  mainContent.style.marginLeft = '250px';
}

// Function to collapse sidebar
function collapseSidebar() {
  sidebar.classList.add('collapsed');
  mainContent.style.marginLeft = '70px';
}

// -------------------- Sidebar Link Click --------------------
document.querySelectorAll('.sidebar .nav-link').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();

    // Highlight active link
    document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
    this.classList.add('active');

    // Expand sidebar if collapsed
    if(sidebar.classList.contains('collapsed')) {
      expandSidebar();
    }

    // Show the selected section
    const text = this.getAttribute('data-text');
    showSection(text);
  });
});

// -------------------- Sidebar Toggle Button --------------------
sidebarToggleBtn.addEventListener('click', function() {
  if(sidebar.classList.contains('collapsed')) {
    expandSidebar();
  } else {
    collapseSidebar();
  }
});

// -------------------- Dashboard Stats --------------------
async function loadDashboardStats() {
  try {
    const res = await fetch('/api/admin/stats');
    const data = await res.json();
    if(data.success){
      document.getElementById("subscribers-count").innerText = data.stats.subscribers;
      document.getElementById("users-count").innerText = data.stats.users;
      document.getElementById("entries-count").innerText = data.stats.entries;
      document.getElementById("notifications-count").innerText = data.stats.notifications;
    }
  } catch(err){
    console.error("Error fetching stats:", err);
  }
}

// -------------------- Subscribers --------------------
async function loadSubscribers() {
  const tbody = document.getElementById("subscribers-table");
  tbody.innerHTML = "<tr><td colspan='7'>Loading...</td></tr>";
  try {
    const res = await fetch('/api/admin/subscribers');
    const data = await res.json();
    if(data.success){
      tbody.innerHTML = "";
      data.subscribers.forEach(s => {
        tbody.innerHTML += `<tr>
          <td>${s.full_name}</td>
          <td>${s.email}</td>
          <td>${s.phone_number}</td>
          <td>${s.state}</td>
          <td>${s.district}</td>
          <td>${s.disease}</td>
<td style="text-align:center;">
  ${s.approved
    ? `<span style="color:green; font-weight:bold;">Approved</span>`
    : `<div class="d-inline-flex justify-content-center align-items-center border border-success rounded" 
           style="width:72px; height:36px; cursor:pointer; background-color:#e6f4ea;" 
           onclick="approveSubscriber(${s.id}, this)" 
           title="Approve Subscriber">
         <i class="bi bi-person-plus text-success" style="font-size:20px;"></i>
       </div>`}
</td>



        </tr>`;
      });
    } else {
      tbody.innerHTML = "<tr><td colspan='7'>No subscribers found</td></tr>";
    }
  } catch(err){
    tbody.innerHTML = "<tr><td colspan='7'>Error loading subscribers</td></tr>";
  }
}

// -------------------- Approve Subscriber --------------------
async function approveSubscriber(id, btn) {
  try {
    const res = await fetch('/api/admin/subscribers/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await res.json();
    if(data.success){
      alert('Subscriber approved successfully!');
      location.reload();
    } else {
      alert('Failed to approve subscriber');
    }
  } catch(err){
    console.error(err);
    alert('Error approving subscriber');
  }
}

// -------------------- Users --------------------
async function loadUsers() {
  const tbody = document.getElementById("users-table");
  tbody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";
  try {
    const res = await fetch('/api/admin/users');
    const data = await res.json();
    if(data.success){
      tbody.innerHTML = "";
      data.users.forEach(u => {
        tbody.innerHTML += `<tr>
          <td>${u.full_name}</td>
          <td>${u.email}</td>
          <td>${u.contact_number}</td>
          <td>${u.gender}</td>
          <td>${formatDate(u.dob)}</td>
          <td>${u.state}</td>
        </tr>`;
      });
    } else {
      tbody.innerHTML = "<tr><td colspan='6'>No users found</td></tr>";
    }
  } catch(err){
    tbody.innerHTML = "<tr><td colspan='6'>Error loading users</td></tr>";
  }
}

// -------------------- Data Entries --------------------
async function loadEntries() {
  const tbody = document.getElementById("entries-table");
  tbody.innerHTML = "<tr><td colspan='9'>Loading...</td></tr>"; // +2 for Delete + Approve columns

  try {
    const res = await fetch('/api/admin/entries');
    const data = await res.json();

    if (data.success) {
      tbody.innerHTML = "";

      data.entries.forEach(e => {
  const tr = document.createElement('tr');

const status = e.is_approved
  ? "<span style='color:green; font-weight:bold;'>Approved</span>"
  : "<span style='color:orange; font-weight:bold;'>Pending</span>";

  let actionHTML = "";

if (e.is_approved) {
  // Approved ‚Üí show Delete only
  actionHTML = `
    <div class="d-inline-flex justify-content-center align-items-center border border-danger rounded" 
     style="width:60px; height:30px; cursor:pointer; background-color:#fbeaea;" 
     onclick="deleteEntry(${e.id}, this)" 
     title="Delete">
  <i class="bi bi-trash text-danger" style="font-size:20px;"></i>
</div>

  `;
} else {
  // Pending ‚Üí show Approve icon only
  actionHTML = `
<div class="d-inline-flex justify-content-center align-items-center border border-success rounded" 
     style="width:60px; height:30px; cursor:pointer; background-color:#e6f4ea;" 
     onclick="approveEntry(${e.id}, this)" 
     title="Approve">
  <i class="bi bi-check text-success" style="font-size:20px;"></i>
</div>

  `;
}


  tr.innerHTML = `
    <td>${e.user_full_name || '-'}</td>
    <td>${e.user_email || '-'}</td>
    <td>${e.state}</td>
    <td>${e.district || '-'}</td>
    <td>${e.disease}</td>
    <td>${e.count}</td>
    <td>${new Date(e.added_at).toLocaleString()}</td>
    <td>${status}</td>
    <td>${actionHTML}</td>
  `;

  tbody.appendChild(tr);
});

    } else {
      tbody.innerHTML = "<tr><td colspan='9'>No entries found</td></tr>";
    }

  } catch (err) {
    tbody.innerHTML = "<tr><td colspan='9'>Error loading entries</td></tr>";
    console.error(err);
  }
}

// -------------------- Delete Entry --------------------
async function deleteEntry(id, btn) {
  if(!confirm("Are you sure you want to delete this entry?")) return;

  try {
    const res = await fetch('/api/data-entry/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    const data = await res.json();

    if(data.success){
      const row = btn.closest('tr');
      row.remove();
      alert('Entry deleted successfully!');
    } else {
      alert(data.message || 'Failed to delete entry.');
    }
  } catch(err){
    console.error(err);
    alert('Server error. Check console.');
  }
}

// -------------------- Approve Entry --------------------
async function approveEntry(id, btn) {
  if (!confirm("Approve this entry and update all site data?")) return;

  btn.disabled = true;
  btn.textContent = "Approving";

  try {
    const res = await fetch(`/api/approve/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    const data = await res.json();

if (data.success) {
  alert("Entry approved and data updated successfully!");
  location.reload();
  btn.textContent = "Approved";
  btn.classList.remove("btn-primary");
  btn.classList.add("btn-secondary");
  btn.disabled = true;

  const statusCell = btn.closest("tr").querySelector("td:nth-child(8)");
  statusCell.innerHTML = "Approved";
  statusCell.style.color = "green";
  statusCell.style.fontWeight = "bold";

  // ‚úÖ Trigger Alerts after approval
  setTimeout(async () => {
    try {
      const alertRes = await fetch('/api/alerts/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ entry_id: id }) // use the approved entry id
      });
      const alertData = await alertRes.json();
      if(alertData.success){
          console.log('Alerts triggered successfully after approval');
      } else {
          console.warn('Alerts trigger failed:', alertData.message);
      }
    } catch(err) {
      console.error('Error triggering alerts after approval:', err);
    }
  }, 1000);

    } else {
      alert(data.message || "Failed to approve entry.");
      btn.disabled = false;
      btn.textContent = "Approve";
    }
  } catch (err) {
    console.error(err);
    alert("Server error during approval.");
    btn.disabled = false;
    btn.textContent = "Approve";
  }
}

// -------------------- Notifications --------------------
async function loadNotifications() {
  const tbody = document.getElementById("notifications-table");
  tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
  try {
    const res = await fetch('/api/notifications');
    const data = await res.json();
    if(data.length === 0){
      tbody.innerHTML = "<tr><td colspan='5'>No notifications sent yet.</td></tr>";
      return;
    }
    tbody.innerHTML = "";
    data.forEach(n => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${n.full_name || '-'}</td>
        <td>${n.recipient_type}</td>
        <td>${n.email || '-'}</td>
        <td>${n.message}</td>
        <td>${new Date(n.created_at).toLocaleString()}</td>
      `;
      tbody.appendChild(row);
    });
  } catch(err){
    console.error(err);
    tbody.innerHTML = "<tr><td colspan='5'>Error loading notifications</td></tr>";
  }
}

// -------------------- Initial Load --------------------
loadDashboardStats();
</script>

<script>
// -------------------- Data Entry Form for Admin --------------------
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('#dataentry-section form');
  const entriesTable = document.getElementById('entries-table');
  const dataStateEl = document.getElementById('dataState');
  const dataDistrictEl = document.getElementById('dataDistrict');

  const maharashtraDistricts = [
    "Mumbai City","Mumbai Suburban","Pune","Nagpur","Nashik","Thane","Aurangabad",
    "Solapur","Amravati","Nanded","Kolhapur","Jalgaon","Akola","Latur","Buldhana",
    "Chandrapur","Gondia","Yavatmal","Washim","Satara","Sindhudurg","Ratnagiri",
    "Raigad","Palghar","Jalna","Parbhani","Hingoli","Beed","Dhule","Nandurbar"
  ];

  function populateDistricts() {
    dataDistrictEl.innerHTML = '<option value="">Select District</option>';
    maharashtraDistricts.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.text = d;
      dataDistrictEl.appendChild(opt);
    });
  }

  function updateDistrictVisibility() {
    if (dataStateEl.value === 'Maharashtra') {
      populateDistricts();
      dataDistrictEl.parentElement.style.display = 'block';
    } else {
      dataDistrictEl.value = '';
      dataDistrictEl.parentElement.style.display = 'none';
    }
  }

  dataStateEl.addEventListener('change', updateDistrictVisibility);
  updateDistrictVisibility();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const disease = form.querySelector('select').value;
    const state = dataStateEl.value.trim();
    const district = dataDistrictEl.value.trim();
    const date = form.querySelector('input[type="date"]').value;
    const count = parseInt(form.querySelector('input[type="number"]').value);

    if (!disease || !state || !date || isNaN(count) || count <= 0 || (state === 'Maharashtra' && !district)) {
      alert('Please fill in all fields correctly.');
      return;
    }

    const payload = { 
      user_id: 3, // admin ID, replace with actual if dynamic
      disease, 
      state, 
      district, 
      count, 
      date 
    };

    try {
      const res = await fetch('/api/data-entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

if (data.success) {
  alert('Entry added successfully!');

  // Add new row to entries table
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>Admin</td>
    <td>Admin@gmail.com</td>
    <td>${state}</td>
    <td>${state === 'Maharashtra' ? district : '-'}</td>
    <td>${disease}</td>
    <td>${count}</td>
    <td>${new Date(date).toLocaleString()}</td>
<td style="color:green; font-weight:bold;">Approved</td>

<td style="text-align:center;">
  <i 
    class="bi bi-trash text-danger" 
    style="cursor:pointer; font-size:20px;" 
    onclick="deleteEntry(${data.entry_id}, this)" 
    title="Delete">
  </i>
</td>


  `;
  entriesTable.prepend(row);

  // Trigger the alert API after 1 second
  setTimeout(async () => {
    try {
      const alertRes = await fetch('/api/alerts/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ entry_id: data.entry_id }) // send the new entry id
      });
      const alertData = await alertRes.json();
      if(alertData.success){
        console.log('Alerts triggered successfully');
      } else {
        console.warn('Alerts trigger failed:', alertData.message);
      }
    } catch(err) {
      console.error('Error triggering alerts:', err);
    }
  }, 1000);

  form.reset();
  updateDistrictVisibility();
} else {
  alert(data.message || 'Failed to add entry.');
}


    } catch (err) {
      console.error(err);
      alert('Server error. Check console.');
    }
  });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
